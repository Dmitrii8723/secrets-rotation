version: 2.1
jobs:
  build:
    docker:
      - image: cimg/base:stable

    steps:
      - checkout

      # Install AWS CLI
      - run:
          name: Install AWS CLI
          command: |
            sudo apt-get update && sudo apt-get install -y awscli

      # Set AWS credentials as environment variables
      - run:
          name: Set AWS credentials
          command: |
            echo "AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID" >> $BASH_ENV
            echo "AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY" >> $BASH_ENV
            echo "AWS_DEFAULT_REGION=$AWS_DEFAULT_REGION" >> $BASH_ENV
            export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
            export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY

      # Set secret ARN as an environment variable
      - run:
          name: Set secret ARN
          command: |
            echo "SECRET_ARN=$SECRET_ARN" >> $BASH_ENV

      # Debug step to print the secret ARN
      - run:
          name: Debug secret ARN
          command: |
            echo "SECRET_ARN: $SECRET_ARN"

      # Retrieve secret value from Secrets Manager
      # Retrieve secret value from Secrets Manager and export it
      - run:
          name: Retrieve secret value
          command: |
            echo "export SECRET_VALUE=$(aws secretsmanager get-secret-value --secret-id $SECRET_ARN --query SecretString --output text --region us-east-1)" >> $BASH_ENV

      # Extract username from secret value and export it
      - run:
          name: Extract username
          command: |
            echo "export DB_USERNAME=$(echo $SECRET_VALUE | jq -r '.username')" >> $BASH_ENV

      # Log out the username
      - run:
          name: Log username
          command: |
            echo "DB_USERNAME: $DB_USERNAME"
      
